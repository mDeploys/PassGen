<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>PassGen Autofill</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 12px; width: 280px; }
    .row { display: flex; gap: 8px; align-items: center; }
    .list { margin-top: 8px; }
    .item { padding: 6px 8px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 6px; display:flex; justify-content: space-between; align-items:center; }
    button { padding: 4px 8px; }
    small { opacity: 0.7; }
    .empty { opacity: 0.8; padding: 8px; text-align: center; }
    .allow { margin-top: 10px; }
  </style>
</head>
<body>
  <div class="row">
    <strong id="domain">(domain)</strong>
    <button id="refresh">Refresh</button>
  </div>
  <div class="allow">
    <label><input type="checkbox" id="allow" /> Allow automatic fill on this site</label>
  </div>
  <div class="list" id="list"></div>
  <div class="empty" id="empty" style="display:none">No saved credentials found for this site.</div>
  <div class="row">
    <small id="status"></small>
  </div>
  <script>
    async function getDomain() {
      const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
      try { return new URL(tab.url).hostname; } catch { return (new URL(tab.url)).host || ''; }
    }
    async function loadAllow(domain) {
      return new Promise(resolve => chrome.storage.local.get(['allowlist'], (d) => {
        const list = d.allowlist || {};
        resolve(!!list[domain]);
      }));
    }
    async function saveAllow(domain, allowed) {
      return new Promise(resolve => chrome.storage.local.get(['allowlist'], (d) => {
        const list = d.allowlist || {};
        list[domain] = !!allowed;
        chrome.storage.local.set({ allowlist: list }, () => resolve(true));
      }));
    }
    async function listCandidates(domain) {
      return new Promise(resolve => chrome.runtime.sendMessage({ type: 'passgen:listCandidates', domain }, (resp) => {
        resolve((resp && resp.ok) ? (resp.names || []) : []);
      }));
    }
    async function fillById(id) {
      return new Promise(resolve => chrome.runtime.sendMessage({ type: 'passgen:fillById', id }, (resp) => {
        resolve(resp && resp.ok);
      }));
    }
    async function render() {
      const domain = await getDomain();
      document.getElementById('domain').textContent = domain;
      const allowed = await loadAllow(domain);
      const chk = document.getElementById('allow');
      chk.checked = allowed;
      chk.onchange = async () => { await saveAllow(domain, chk.checked); };
      const names = await listCandidates(domain);
      const listEl = document.getElementById('list');
      const emptyEl = document.getElementById('empty');
      listEl.innerHTML = '';
      if (!names.length) { emptyEl.style.display = 'block'; return; } else { emptyEl.style.display = 'none'; }
      for (const n of names) {
        const div = document.createElement('div');
        div.className = 'item';
        const span = document.createElement('span');
        span.textContent = n.name;
        const btn = document.createElement('button');
        btn.textContent = 'Fill';
        btn.onclick = async () => {
          const ok = await fillById(n.id);
          document.getElementById('status').textContent = ok ? 'Filled in page.' : 'Failed to fill.';
        };
        div.appendChild(span);
        div.appendChild(btn);
        listEl.appendChild(div);
      }
    }
    document.getElementById('refresh').onclick = render;
    render();
  </script>
</body>
</html>
